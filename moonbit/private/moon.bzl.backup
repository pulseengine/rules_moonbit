"""Core MoonBit rule implementations - PRIVATE"""

# Copyright 2026 The Rules_Moonbit Authors. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Use native depset for now
load("//moonbit:providers.bzl", "MoonbitInfo")
load("//moonbit/private:compilation.bzl", 
     "find_moon_executable", 
     "create_compilation_action", 
     "parse_metadata",
     "create_test_action")

"""MoonBit Library Rule"""

def _moonbit_library_impl(ctx):
    """Implements the moonbit_library rule."""
    # Get sources
    srcs = ctx.files.srcs
    
    # Determine output file
    output_file = ctx.actions.declare_file("%s.compiled" % ctx.label.name)
    
    # Create compilation action
    compiled_output = create_compilation_action(ctx, output_file, srcs)
    
    # Parse metadata
    metadata = parse_metadata(ctx)
    
    # Collect transitive dependencies (simplified for now)
    transitive_deps = [srcs]
    for dep in ctx.attr.deps:
        if hasattr(dep, 'transitive_deps'):
            transitive_deps.append(dep.transitive_deps)
    
    return [MoonbitInfo(
        compiled_objects = [compiled_output],
        transitive_deps = transitive_deps,
        package_name = ctx.label.name,
        is_main = False,
        metadata = metadata,
    )]

moonbit_library = rule(
    implementation = _moonbit_library_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
    },
)

"""MoonBit Binary Rule"""

def _moonbit_binary_impl(ctx):
    """Implements the moonbit_binary rule."""
    # Get sources
    srcs = ctx.files.srcs
    
    # Determine output file (executable)
    output_file = ctx.actions.declare_file("%s.exe" % ctx.label.name)
    
    # Create compilation action
    compiled_output = create_compilation_action(ctx, output_file, srcs)
    
    # Parse metadata
    metadata = parse_metadata(ctx)
    
    # Collect transitive dependencies
    transitive_deps = [srcs]
    for dep in ctx.attr.deps:
        if hasattr(dep, 'transitive_deps'):
            transitive_deps.append(dep.transitive_deps)
    
    return [MoonbitInfo(
        compiled_objects = [compiled_output],
        transitive_deps = transitive_deps,
        package_name = ctx.label.name,
        is_main = True,
        metadata = metadata,
    )]

moonbit_binary = rule(
    implementation = _moonbit_binary_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
    },
)

"""MoonBit Test Rule"""

def _moonbit_test_impl(ctx):
    """Implements the moonbit_test rule."""
    # Get sources
    srcs = ctx.files.srcs
    
    # Create test action
    create_test_action(ctx, srcs)
    
    # Get dependencies
    deps = ctx.attr.deps
    
    # Collect transitive dependencies
    transitive_deps = [srcs]
    for dep in deps:
        if hasattr(dep, 'transitive_deps'):
            transitive_deps.append(dep.transitive_deps)
    
    # Create a test executable (required for test rules)
    test_executable = ctx.actions.declare_file(ctx.label.name + "_test")
    ctx.actions.write(
        output = test_executable,
        content = "#!/bin/bash\n# MoonBit test placeholder\necho 'MoonBit test: " + ctx.label.name + "'\n",
        is_executable = True
    )
    
    # Test rules need to return DefaultInfo with executable
    return [DefaultInfo(executable = test_executable), MoonbitInfo(
        compiled_objects = [test_executable],
        transitive_deps = transitive_deps,
        package_name = ctx.label.name,
        is_main = False,
        metadata = {"test_type": "moonbit"},
    )]

moonbit_test = rule(
    implementation = _moonbit_test_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit test source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
    },
    test = True,
)

"""Multi-Target MoonBit Rules"""

def _moonbit_target_impl(ctx, target="wasm", extension=".wasm"):
    """Generic implementation for target-specific MoonBit compilation."""
    # Get sources
    srcs = ctx.files.srcs
    
    # Determine output file based on target
    output_file = ctx.actions.declare_file(ctx.label.name + extension)
    
    # Create compilation action
    compiled_output = create_compilation_action(ctx, output_file, srcs)
    
    # Parse metadata
    metadata = parse_metadata(ctx)
    
    # Collect transitive dependencies
    transitive_deps = [srcs]
    for dep in ctx.attr.deps:
        if hasattr(dep, 'transitive_deps'):
            transitive_deps.append(dep.transitive_deps)
    
    return [MoonbitInfo(
        compiled_objects = [compiled_output],
        transitive_deps = transitive_deps,
        package_name = ctx.label.name,
        is_main = ctx.attr.is_main if hasattr(ctx.attr, 'is_main') else False,
        metadata = metadata,
        target = target,
    )]

def _moonbit_wasm_impl(ctx):
    """Implements the moonbit_wasm rule for WebAssembly compilation."""
    return _moonbit_target_impl(ctx, target="wasm", extension=".wasm")

def _moonbit_js_impl(ctx):
    """Implements the moonbit_js rule for JavaScript compilation."""
    return _moonbit_target_impl(ctx, target="js", extension=".js")

def _moonbit_c_impl(ctx):
    """Implements the moonbit_c rule for C compilation."""
    return _moonbit_target_impl(ctx, target="c", extension=".c")

moonbit_wasm = rule(
    implementation = _moonbit_wasm_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
        "is_main": attr.bool(
            doc = "Whether this is a main/executable target",
            default = False,
        ),
    },
)

moonbit_js = rule(
    implementation = _moonbit_js_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
        "is_main": attr.bool(
            doc = "Whether this is a main/executable target",
            default = False,
        ),
    },
)

moonbit_c = rule(
    implementation = _moonbit_c_impl,
    attrs = {
        "srcs": attr.label_list(
            doc = "MoonBit source files",
            allow_files = True,
            mandatory = True,
        ),
        "deps": attr.label_list(
            doc = "Dependencies",
            allow_files = False,
            mandatory = False,
        ),
        "is_main": attr.bool(
            doc = "Whether this is a main/executable target",
            default = False,
        ),
    },
)